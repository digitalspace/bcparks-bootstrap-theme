name: Publish to NPM

run-name: Publishing ${{ github.event.inputs.releaseTag }}

on:
  workflow_dispatch:
    inputs:
      releaseTag:
        description: "Tag of version to be published to NPM"
        required: true

jobs:
  publish:
    name: "Publish to GitHub Packages and NPM"
    runs-on: ubuntu-20.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Set env var
        run: echo "RELEASE_TAG=$EVENT" >> $GITHUB_ENV
        env:
          EVENT: ${{ github.event.inputs.releaseTag }}

      # Create GH Release
      - name: Create Release
        uses: "actions/github-script@v6"
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          script: |
            try {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: process.env.RELEASE_TAG,
                name: process.env.RELEASE_TAG,
                draft: false,
                prerelease: false,
                generate_release_notes: true,
                make_latest: "true"
              });
            } catch (error) {
              core.setFailed(error.message);
            }

      - name: Get package
        uses: actions/download-artifact@v3
        with:
          name: ${{ github.event.inputs.releaseTag }}-package
      - run: yarn publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          registry-url: https://npm.pkg.github.com/
          scope: "@digitalspace"
      - run: echo "registry=https://npm.pkg.github.com/@digitalspace" >> .npmrc
      - run: yarn publish $(ls *.tgz)
        env:
          NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}
